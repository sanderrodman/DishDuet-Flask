<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>DishDash</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
</head>

<body class="flex">
    <aside class="flex">
        <header>
            <h1 class="color-2">ðŸ¥™ Dish</h1>
            <h1 class="color-1">Dash ðŸ¥˜</h1>
        </header>
        <div class="small-aside">
            <div class="top-text">
                <div>
                    <label for="filter-text-val">Search For Recipes</label>
                    <div class="input-box" onclick="sendFocus()">
                        <img alt="" src="{{ url_for('static', filename='images/mag.png') }}" />
                        <input type="text" placeholder="What's Cooking?" class="mainLoginInput" id="filter-text-val">
                    </div>
                </div>

                <div>
                    <div class="flex" id="unwanted-box">
                        <label for="unwanted">What to Avoid</label>
                        <input type="text" placeholder="mushrooms..." class="mainLoginInput" id="unwanted">
                    </div>
                </div>
            </div>
            <div class="side_by_side">
                <div class="allergen_container">
                    <h3>Allergies</h3>

                    <label class="allergen_container"><input type="checkbox" name="allergy-type"
                            value="nut">Nut</label><br />
                    <label class="allergen_container"><input type="checkbox" name="allergy-type"
                            value="vegetarian">Vegetarian</label><br />
                    <label class="allergen_container"><input type="checkbox" name="allergy-type"
                            value="vegan">Vegan</label><br />
                    <label class="allergen_container"><input type="checkbox" name="allergy-type"
                            value="dairy">Dairy</label><br />
                    <label class="allergen_container"><input type="checkbox" name="allergy-type"
                            value="dairy">Egg</label><br />
                    <label class="allergen_container"><input type="checkbox" name="allergy-type"
                            value="gluten">Gluten</label><br />
                    <label class="allergen_container"><input type="checkbox" name="allergy-type"
                            value="shellfish">Shellfish</label><br />
                </div>
                <div class="search flex">
                    <div class="time_constraint_container">
                        <h3>Cook Time</h3>

                        <label class="time_constraint_container">Max Minutes:<input id="time" type="number" name="time-type" value="60"></label>
                    </div>
                    <button id="search" onclick="filterText()">search</button>
                </div>

            </div>
        </div>
    </aside>
    <main>
        <div id="answer-box">
        </div>
    </main>
    <div id="recipe-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
        </div>
    </div>

    <script>

        function star(rating, reviewcount) {
            if (4.8 <= rating) {
                return `<img src="{{ url_for('static', filename='images/star.svg') }}">
                <img src="{{ url_for('static', filename='images/star.svg') }}">
                <img src="{{ url_for('static', filename='images/star.svg') }}">
                <img src="{{ url_for('static', filename='images/star.svg') }}">
                <img src="{{ url_for('static', filename='images/star.svg') }}">`+ `<p>(${reviewcount})</p>`
            }
                
            img = ``
            i = 1

            while (i < rating) {
                img += `<img src="{{ url_for('static', filename='images/star.svg') }}">\n`
                i += 1
            }

            if (i - rating <= 0.5) {
                img += `<img src="{{ url_for('static', filename='images/half.svg') }}">\n`
                i += 1
            }

            while (i <= 5) {
                img += `<img src="{{ url_for('static', filename='images/no.svg') }}">\n`
                i += 1
            }

            return img + `<p>(${reviewcount})</p>`
            }


        function answerBoxTemplate(dishname, rating, reviewcount, img, time, ingredients) {
            return`
            <div class='result flex'>
                <div>
                    <h3 id='recipe-name' class='recipe-title'>${dishname}</h3>
                    <div class="flex star">
                        ${star(rating, reviewcount)}
                    </div>
                    <ul>${printIngredients(ingredients)}</ul>
                    <strong>${time} min</strong>
                </div>
                <img src="${img}" alt="${dishname}">
            </div>`
        }


        function printIngredients(ingredients) {

            if (ingredients.length != 0) {
                const firstElement = ingredients.shift();
                return `<li>${firstElement}</li>` + printIngredients(ingredients);
            }
            else {
                return ``;
            }
        }

        function sendFocus() {
            document.getElementById('filter-text-val').focus()
        }

        // popup box that has the recipe. Pops up when the user clicks on the 
        // title of the recipe.
        function recipeBoxTemplate(dishname, rating, reviewcount, img, time, ingredients, instructions) {
            return `
            <div class='result flex'>
                <div>
                    <img src="${img}" alt="${dishname}">
                    <h2 class='recipe-title'>${dishname}</h2>
                    <div class="flex star">
                        ${star(rating, reviewcount)}
                    </div>
                    <ul>${printIngredients(ingredients)}</ul> 
                </div>
                <p>Time: ${time}</p>
                <h3>Instructions</h3>
                <div>
                    <ol>${printIngredients(instructions)}</ol>
                </div>
            </div>
            `
        }

        function filterText() {
            document.body.scrollTop = document.documentElement.scrollTop = 0; // sends screen to top of page
            document.getElementById("answer-box").innerHTML = "";
            console.log(document.getElementById("filter-text-val").value);
            
            var allergies = "";
            var inputElements = document.getElementsByName("allergy-type");
            for (var i=0; i<inputElements.length; ++i) {
                if (inputElements[i].checked) {
                    allergies += inputElements[i].value + " " // collects checked allergies
                }
            }

            var time = 0;
            var inputElements = document.getElementsByName("time-type");
            for (var i=0; i<inputElements.length; ++i) {
                if (inputElements[i].checked) {
                    time = inputElements[i].value; // collects checked time
                }
            }

            time = document.getElementsByName("time-type")[0].value;
            
            var inputElements = document.getElementsByName("allergy-type");

            fetch("/recipes?" + new URLSearchParams({

                dishname: document.getElementById("filter-text-val").value,
                unwanted: document.getElementById("unwanted").value,
                allergies: allergies,
                time: time
        
            }).toString())

            .then((response) => response.json())
            .then((data) => data.forEach(row => {
                let tempDiv = document.createElement("div");
                tempDiv.innerHTML = 
                answerBoxTemplate(row.dishname, row.aggregatedrating, row.reviewcount, row.images, row.time, row.ingredientparts);
                console.log(row.images)
                console.log(row.dishname)
                document.getElementById("answer-box").appendChild(tempDiv);
   

            }));

            // Get the modal
            var modal = document.getElementById("recipe-modal");

            // Get the button that opens the modal
            var btn = document.getElementById("recipe-name");

            // Get the <span> element that closes the modal
            var span = document.getElementsByClassName("close")[0];

            // When the user clicks on the button, open the modal
            btn.onclick = function() {
                let tempDivRecipe = document.createElement("div");
                tempDivRecipe.innerHTML = 
                recipeBoxTemplate(row.dishname, row.aggregatedrating, 
                row.reviewcount, row.images, row.time, row.ingredientparts, row.instructions, row.time);
                document.getElementById("modal-content").appendChild(tempDivRecipe);
                modal.style.display = "block";
            }

            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
            modal.style.display = "none";
            }
        }

    </script>
</body>

</html>